$(document).ready(function () {
  $('.blog-content .faq__item .faq__item-body.jsTogglerBody').eq(0).show();
  //$('.faq-js .faq__box .faq__item-body.jsTogglerBody').eq(0).show();
  
  // a.ivanov
/*  $('#smsCode').on('input, keyup', function() {
      console.log('input');
      if($(this).val()) {
          $(this).closest('.form__item').show();
      }
  });*/
  // a.ivanov end
  
});
$(document).on('af_complete', function(event, response) {
    var form = response.form;
    if (form.attr('id') == 'modal_form') {
        if (response.success){
            console.log('[DISCOUNT DEBUG] SUCCESS! Starting discount flow...');
        		$.fancybox.close();
        		$.fancybox.open('<div class="message"><p>Thank you for your request. Our manager will contact you shortly.</p></div>');
        }
    }

    // a.ivanov
    if (form.attr('id') == 'modal_form_discount') {
        console.log('[FORM DEBUG] Submit. serializeArray:', form.serializeArray());
        console.log('[DISCOUNT DEBUG] Form submitted. Response:', response);
        
        if (response.success){
            console.log('[DISCOUNT DEBUG] SUCCESS! Code verified. Starting discount flow...');
            $.fancybox.close();
            $.fancybox.open('<div class="message"><p>Thank you for your request. Our manager will contact you shortly.</p></div>');

            $.ajax({
                type: 'POST',
                url: '/ajax-discount.html',
                dataType: 'json',
                cache: false,
                data: {
                    action: 'getDiscount'
                },
                success: function(data) {
                    var group = $('#filter-form input[name=group]:checked').val();
                    var category = '';
                    $('#step-5-filter input[type=checkbox]:checked').each(function() {
                        if(category == '') {
                            category = $(this).val();
                        } else {
                            category = category + ',' + $(this).val();    
                        }
                    });
                    
                    let url = '';
                    if(group !== 'undefined' || group !== '') {
                        url = form.attr('action') + '?filtergroup=' + group;
                    }
                    if(category !== 'undefined' || category !== '') {
                        url = url + '&filtercategory=' + category;
                    }
                    document.location.href = url;
                }
                ,error: function(jqXHR, textStatus, errorThrown) {
                    alert(textStatus + ' ' + errorThrown);
                },
                beforeSend : function() {
                },
            });

        } else {
            // SMS code needed - switch to Panel 2
            if(response.data.sms_code !== undefined) {
                console.log('[DISCOUNT DEBUG] SMS code required. Switching to Panel 2...');
                
                // Hide Panel 1, show Panel 2
                $('#panel_1').hide();
                $('#panel_2').show();
                
                // Start 30-second timer
                startResendTimer();
                
                // Setup resend link handler (remove old handlers first)
                $('.jsSmsRepeat').off('click').on('click', function(e) {
                    e.preventDefault();
                    console.log('[DISCOUNT DEBUG] Resend code requested');
                    
                    // Hide resend link, show timer
                    $('#resend_link').hide();
                    $('#resend_timer').show();
                    $("#smsCode").val(""); // Clear old SMS code
                    
                    // Add repeat_sms flag and submit form
                    $('#panel_2').find('input[name=repeat_sms]').remove();
                    $('#panel_2').append('<input type="hidden" name="repeat_sms" value="1">');
                    form.find('button[type="submit"]').trigger('click');
                    
                    // Restart timer after submission
                    setTimeout(function() {
                        startResendTimer();
                    }, 500);
                });
            }
        }
    }
    // a.ivanov end

    if (form.attr('id') == 'feedback_form') {
        if (response.success){
            console.log('[DISCOUNT DEBUG] SUCCESS! Starting discount flow...');
  		      $.fancybox.open('<div class="message"><p>Thank you for your request. Our manager will contact you shortly.</p></div>');
        }
    }
});

$(document).on('mse2_load', function (e, data) {
	$('.jsTwenty').twentytwenty();
});


$(document).ready(function () {

    $(document).on('click', '.jsMorereview', function(){
      let master_id = $(this).attr('data-master');  
      let start = 3;
      let star_more = $(this).attr('data-count');  

      //console.log(master_id);

      $.ajax({
        type: 'POST',
        url: '/ajax-more.html',
        dataType: 'json',
        cache: false,
        data: ({'starmore': star_more,'master_id': master_id}),
        success: function(data) {
          $('.reviews__content').css('opacity', 1);
          //console.log(data);
          //$('.jsMorereview').remove();
          //let more_html = '<a data-count="'+start+'" data-master="" class="btn jsMorereview" href="#">View more review</a>';
          //$('#centered-box').append(more_html);
          let star_more = parseInt($('.jsMorereview').attr('data-count')); 
          let sum = star_more + 3;
          $('.jsMorereview').attr('data-count',sum);
          $('.reviews__content').append(data.service);

          if (sum > data.allcount) {
            $('.jsMorereview').remove();
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            alert(textStatus + ' ' + errorThrown);
        },
        beforeSend : function() {
          $('.reviews__content').css('opacity', .5);
        },
      });
      return false;

    })


  $(document).on('click', '.cky-btn-accept', function () {
		$('.cky-box-bottom-left').remove();
	  $.cookie('accept', 'accept', { expires: 7 });
	    
	})
	$(document).on('click', '.cky-btn-reject', function () {
		$('.cky-box-bottom-left').remove();
	    $.cookie('accept', 'accept', { expires: 7 });

	})


  

  $('.specialist-item').each(function(){
      var max = 4; // - количество отображаемых разделов
      if ($(this).find(".specialist-item__body ul li").length > max) {
        $(this).find('.specialist-item__body ul li:gt(3)').hide();
        let url = $(this).closest('.specialist-item').attr('href');
        $(this).find('.specialist-item__body ul').append('<a href="'+url+'" class="read">see more</a>');
        /*
        $(document).on('click', '.specialist-item .read', function () {
          $(this).parent().find('li').show();
          $(this).remove();
          return false;
        })
        */
      }
  });


});



//video
$(document).on('click', '.ajaxVideoJS', function(){
    var resource_id = $(this).data('id');
    $.ajax({
    type: 'POST',
    url: '/ajax-video.html',
    dataType: 'json',
    cache: false,
    data: {
        action:'video',
        resource_id: resource_id
    },
    success: function(data) {
      if(data.text) {
        $.fancybox.open('<div class="modal style_popup_content">'+data.text+'</div>');
      }
    },
    error: function(jqXHR, textStatus, errorThrown) { 
        alert(textStatus + ' ' + errorThrown);
    },
  });
  return false;
});

$(document).on('click', '.ajaxVideoShortsJS', function(){
    var resource_id = $(this).data('id');
    $.ajax({
    type: 'POST',
    url: '/ajax-video.html',
    dataType: 'json',
    cache: false,
    data: {
        action:'videoShorts',
        resource_id: resource_id
    },
    success: function(data) {
      if(data.text) {
        $.fancybox.open('<div class="modal style_popup_content">'+data.text+'</div>');
      }
    },
    error: function(jqXHR, textStatus, errorThrown) { 
        alert(textStatus + ' ' + errorThrown);
    },
  });
  return false;
});
// ========== DEBUG: Submit handler (BEFORE form submission) ==========
$(document).on('submit', '#modal_form_discount', function(e) {
    var formData = $(this).serializeArray();
    console.log('[SUBMIT DEBUG] Form is being submitted. Data:', formData);
    console.log('[SUBMIT DEBUG] SMS field value:', $('#smsCode').val());
    console.log('[SUBMIT DEBUG] SMS field visible:', $('#smsCode').is(':visible'));
    console.log('[SUBMIT DEBUG] SMS field disabled:', $('#smsCode').is(':disabled'));
    // Don't prevent default - let form submit normally
});
// ========== END DEBUG ==========

// ========== TIMER FUNCTION for Resend SMS Code ==========
function startResendTimer() {
    var seconds = 60;
    $('#timer_countdown').text(seconds);
    $('#resend_timer').show();
    $('#resend_link').hide();
    
    var interval = setInterval(function() {
        seconds--;
        $('#timer_countdown').text(seconds);
        
        if (seconds <= 0) {
            clearInterval(interval);
            $('#resend_timer').hide();
            $('#resend_link').show();
        }
    }, 1000);
}
// ========== END TIMER FUNCTION ==========
